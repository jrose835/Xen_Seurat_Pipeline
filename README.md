# **Xenium Seurat-Based Transcript Processing Pipeline**

Created for the Santangelo Lab at Emory University

---

## **Purpose**

This pipeline performs traditional single-cell RNA-seq analysis (normalization, clustering, UMAP) on output bundles generated by the 10x Xenium spatial transcriptomics platform. It is designed for small panels (100–480 genes), but can be easily adapted for larger panels such as the Xenium Prime 5K.

---

## **Pipeline Overview**

### **Script 1: `Xen_Seurat_LoadQCPCA.R`**

1. Load Xenium data from onboard analysis output
2. Import additional metadata (e.g., cell area, MFI)
3. Perform cell-level quality control (QC)
4. Integrate samples into a single Seurat object
5. Normalize counts
6. Perform dimensionality reduction (PCA)

### **Script 2: `Xen_Seurat_ClusterAnnot.R`**

1. Identify nearest neighbors
2. Perform clustering
3. Generate UMAP embeddings

---

## **Analysis Options**

### **Normalization Methods**
- **Log**: Standard Seurat `LogNormalize` method (log(count / library size))
- **LogArea**: Custom normalization replacing library size with cell area; outputs intensity as counts per 100 µm²
- **SCT**: SCTransform normalization; models technical noise using negative binomial regression. See [Seurat documentation](https://satijalab.org/seurat/articles/sctransform_v2_vignette.html)

### **Batch Integration Options**
- **None**: No integration (simple concatenation of datasets)
- **Seurat CCA**: Canonical correlation analysis ([Reference](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6700744/))
- **Seurat RPCA**: Recommended for large or unbalanced datasets ([Guide](https://satijalab.org/seurat/articles/integration_rpca.html))
- **Harmony**: Fast batch correction using iterative PCA alignment ([Harmony GitHub](https://github.com/immunogenomics/harmony))

---

## **Inputs**

- **Xenium Output Bundle**: Directory from 10x Genomics
- **Manifest File**: `sample_manifest.csv` containing the following columns:
  - `run_name`: Descriptive name for the region
  - `experiment`: Group or cohort identifier
  - `condition`: Experimental condition (e.g., treatment, control)
  - `xen_dir`: Path to Xenium output
  - `alt_input`: Boolean flag to indicate additional metadata import
  - `alt_input_dir`: Path to alternate metadata directory

---

## **Outputs**

### **Script 1**
- `output/pipeline/objs/`: Integrated & processed `.rds` Seurat object
- `output/qc/experiment_cellstats.csv`: Raw QC stats
- `output/qc/experiment_filtered_cellstats.csv`: Filtered QC stats
- `output/qc/images/`: Full and filtered cell images (`.png`)
- `output/qc/plots/`: 
  - Cell area histogram  
  - nCount threshold plot  
  - nFeature threshold plot  
  - Feature scatter plot
- `output/pipeline/objs/`: Individual filtered Seurat objects (no processing)
- `output/pipeline/pca/`: PCA elbow plots (`experiment_PCAelbow.png`)
- `output/pipeline/pca/joint_unintegrated/`: Dim. loading & PC plots
- `Rsession_info.txt`: R session log

### **Script 2**
- `output/pipeline/objs/`: Seurat object with UMAP & cluster results
- `output/pipeline/umap/`: UMAP plots per clustering resolution
- `output/pipeline/clustree.png`: Clustering hierarchy graph
- `output/visualization/`: 
  - UMAP plots colored by cluster and run ID  
  - (Optional) Image plots colored by spatial metadata

---

## **How to Run**

```bash
#!/bin/bash

cd /path/to/your/project

# Restore R environment
R -e "renv::restore()"

# Run Script 1
Rscript Xen_Seurat_LoadQCPCA.R 2>&1 | tee Xen_Seurat_LoadQCPCA.R.log
```

Inspect the outputs (PCA plots, QC metrics) to choose appropriate parameters (e.g., number of PCs, clustering resolution), then run:

```bash
# Run Script 2
Rscript Xen_Seurat_ClusterAnnot.R | tee Xen_Seurat_ClusterAnnot.R.log
```
